var MapControl=function(k,c,e){if(arguments.length!=3){throw new Error("传入参数个数错误,当前个数"+arguments.length+",应传入三个参数。")}if(!k){throw new Error("MapControl构造方法中传入的容器id为空。")}var o=this,d=14,f={};var i=c;this.data=function(q){if(!arguments.length){return i}i=q;return this};var n=[];this.transportList=function(){if(!arguments.length){return n}n=value;return this};this.mapStyle=function(){return o.data()&&o.data().mapStyle?o.data().mapStyle:"midnight"};this.mode=function(){return o.data()&&o.data().mode?o.data().mode:"normal"};var b=new BMap.Map(k,{enableMapClick:!1});this.map=function(q){if(!arguments.length){return b}b=q;return this};var a=function(){n.length=0;var y=ObjectUtil.cloneObj(o.data());for(var t,z,q,r,w=0,x=y.length;w<x;w++){r=y[w];q=r.id;z=r.transportList;for(var v=0,u=z.length;v<u;v++){t=z[v];t.pos=t.currentPos&&t.currentPos.pos?t.currentPos.pos:null;if(!t.pos){continue}t.time=t.currentPos.time;t.addr=t.currentPos.address;t.orderId=q;n.push(t)}}};this.init=function(){a();b.centerAndZoom(new BMap.Point(116.404,39.915),12);b.enableScrollWheelZoom(true);b.setMapStyle({style:o.mapStyle()});o.initControl();o.initOverlay();o.addListeners();o.addItems(o.transportList());o.initLocation(o.transportList());o.validateMode();$(".init-loading").css({display:"none"})};this.validateMode=function(){if(o.mode()==="clusterer"){var r=[];for(var t in f){r.push(f[t].item)}var u={data:r,gridSize:100,maxZoom:15,minClusterSize:2,isAverangeCenter:true};var q=new BMapLib.MarkerClusterer(o.map(),u)}};this.initLocation=function(r){var w=[];for(var t=0,q=r.length;t<q;t++){var v=r[t].pos;w.push(new BMap.Point(v[0],v[1]))}if(w.length>1){b.setViewport(w)}else{if(w.length===1){b.setCenter(w[0]);b.setZoom(10)}else{var u=new BMap.LocalCity();u.get(function(x){var y=x.name;b.setCenter(y)})}}};this.initControl=function(){o.addCityListControl();o.addNavigationControl();o.addScaleControl();o.addMapTypeControl();o.addOrderTableControl()};this.initOverlay=function(){};this.addListeners=function(){window.onresize=o.resizeUI};this.resizeUI=function(){};this.addCityListControl=function(){o.cityListControl=new BMap.CityListControl({anchor:BMAP_ANCHOR_TOP_LEFT,offset:new BMap.Size(320,10)});b.addControl(o.cityListControl);o.cityListControl.hide()};this.removeCityListControl=function(){b.removeControl(o.cityListControl)};this.addNavigationControl=function(){o.navigationControl=new BMap.NavigationControl({type:BMAP_NAVIGATION_CONTROL_ZOOM,anchor:BMAP_ANCHOR_TOP_RIGHT,offset:new BMap.Size(10,12)});b.addControl(o.navigationControl)};this.removeNavigationControl=function(){b.removeControl(o.navigationControl)};this.addScaleControl=function(){o.scaleControl=new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,offset:new BMap.Size(100,10)});b.addControl(o.scaleControl)};this.removeScaleControl=function(){b.removeControl(o.scaleControl)};this.addMapTypeControl=function(){o.mapTypeControl=new BMap.MapTypeControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,offset:new BMap.Size(10,10),mapTypes:[BMAP_NORMAL_MAP,BMAP_HYBRID_MAP]});b.addControl(o.mapTypeControl)};this.removeMapTypeControl=function(){b.removeControl(o.mapTypeControl)};this.addOrderTableControl=function(){o.orderTableControl=new OrderTableControl(o);o.orderTableControl.init(o.data())};this.removeOrderTableControl=function(){b.removeControl(o.orderTableControl)};this.addTransportTableControl=function(w,v){if(w){var t=ObjectUtil.cloneObj(w.transportList);var r=w.id;for(var u=0,q=t.length;u<q;u++){t[u].orderId=r}if(!o.transportTableControl){o.transportTableControl=new TransportTableControl(o,t,v);b.addControl(o.transportTableControl)}else{o.transportTableControl.setContent(t,false,v)}}};this.removeTransportTableControl=function(){if(o.transportTableControl){b.removeControl(o.transportTableControl);o.transportTableControl=null}};var h=function(q,u,t){var r=new BMap.Geocoder();if(isNaN(u)){u=3}else{if(u>4){u=4}else{if(u<0){u=0}}}r.getLocation(q,function(v){var x=v.addressComponents;var w;if(u===0){w=x.province}else{if(u===1){w=x.city}else{if(u===2){w=x.city+x.district}else{if(u===3){w=x.city+x.district+x.street}else{w=x.city+x.district+x.street+x.streetNumber}}}}if(x.province!==x.city){w=x.province+w}if(t){t.call(null,w)}})};var m=function(r,q){return'<svg id="info_window_svg_'+r+'" verson="1.1" style="position:absolute;width:50px;height:200px;"><polyline points="0,195 25,65 50,65" style="stroke:rgba(68,123,175,0.75);stroke-width:2;fill:none;"/></svg><div id="info_window_content_'+r+'" class="info_window_content"><div class="tl_border"></div><div class="tr_border"></div><div class="bl_border"></div><div class="br_border"></div><div><span style="padding-left:26px;">订单编号：</span>'+r+'</div><div><span style="padding-left:26px;">车牌：</span>'+q+'</div><div><a class="link" target="_blank" href="'+e+r+'"><span class="link_span" style="padding-left:26px;pointer-events:all;">点击查看</span><a></div></div>'};var p=function(q){return'<div class="info_label_content"><div><span>车牌：</span>'+q+"</div></div>"};var l=function(r,q){return"订单编号："+r+"\n车牌："+q};var g=function(q){var r;switch(q){case"离线":r="othertypeoffline";break;case"静止":r="othertypestatic";break;default:r="othertype";break}var v="assets/images/"+r+".png";var t=new BMap.Size(44*0.6,54*0.6);var u=new BMap.Icon(v,t);u.setImageSize(t);return u};var j=function(r){var q=d3.transition().duration(200).delay(500).ease(d3.easeExpOut);d3.select("#info_window_content_"+r).style("opacity",0).style("transform","translate(100px, 0px)");d3.select("#info_window_svg_"+r).style("transform-origin","left bottom").style("transform","scale(0, 0)").transition(q).style("transform","scale(1, 1)").on("end",function(){var t=d3.transition().duration(200).delay(100).ease(d3.easeExpOut);d3.select("#info_window_content_"+r).transition(t).style("opacity",1).style("transform","translate(0px, 0px)")})};this.getValueByKey=function(q,r){return r?r[q]:null};this.visibleItem=function(u,t){var r=o.getValueByKey(u,f);if(!r){return}var q=r.item;if(q){t?q.show():q.hide()}};this.selectItem=function(q,r,A){var u=o.getValueByKey(q,f);if(!u){return}var z=u.item;var w=u.infoLabel;w.hide();var t=u.infoWindow;z.setZIndex(2222222222);t.show();z.setLabel(t);j(q);var v=u.data;var x=v.pos;if(!x){return}var y=new BMap.Point(x[0],x[1]);if(A){b.setZoom(d)}if(r){b.panTo(y)}o.resizeUI()};this.unselectItem=function(v){var t=o.getValueByKey(v,f);if(!t){return}var r=t.item;r.setZIndex(0);var q=t.infoWindow;q.hide();var u=t.infoLabel;u.show();r.setLabel(u)};this.addItem=function(v,z,q){var r=ObjectUtil.filterObj(v,"id");var F=f[r]?true:false;r=ObjectUtil.filterObj(v,"id","未知");var t=ObjectUtil.filterObj(v,"orderId","未知");var B=ObjectUtil.filterObj(v,"carNumber","未知");var A=v.pos;var D=new BMap.Point(A[0],A[1]);var E=F?f[r].item:new BMap.Marker();E.setPosition(D);var y=g(status);var C=l(t,B);E.setTitle(C);E.setIcon(y);if(z){b.setZoom(d);b.panTo(D)}var w=m(t,B);var u=F?f[r].infoWindow:new BMap.Label(w);u.setOffset(new BMap.Size(10,-185));u.setStyle({width:"350px",height:"200px",padding:"0px","background-color":"rgba(0,0,0,0)","border-color":"rgba(0,0,0,0)",color:"#fff","font-size":"13px","font-family":"微软雅黑 宋体","pointer-events":"none"});u.hide();w=p(B);var x=F?f[r].infoLabel:new BMap.Label(w);x.setOffset(new BMap.Size(10,10));x.setStyle({padding:"0px","background-color":"rgba(0,0,0,0)","border-color":"rgba(0,0,0,0)",color:"#fff","font-size":"12px","font-family":"微软雅黑 宋体","pointer-events":"none"});E.setLabel(x);f[r]={item:E,data:v,infoWindow:u,infoLabel:x};if(F){u.setContent(w);u.draw()}else{if(o.mode()==="normal"){b.addOverlay(E)}E.addEventListener("click",function(){var T=$("#table");var H=T.tabulator("getData");var G=0;var S=0;var I,R;start:for(var Q,J,R,M=0,N=H.length;M<N;M++){J=H[M];R=J.transportList;for(var L=0,K=R.length;L<K;L++){if(R[L].id===r){G=M;S=L;I=J.id;R=J.transportList;break start}}}var O=Math.floor(G/10)+1;T.tabulator("setPage",O);T.tabulator("selectRow",I);var P=T.tabulator("getSelectedData");P=P.length>0?P[0]:null;o.orderTableControl.selectRow(P,function(){var U=$("#transportTable");H=U.tabulator("getData");U.tabulator("selectRow",r);o.transportTableControl.selectRow(R[S])})})}if(q){u.show();j(r)}$("#table").tabulator("updateData",[v])};this.updateItem=function(q){o.addItem(q)};this.removeItem=function(r){var q=f[r];if(q){b.removeOverlay(q.item);delete f[r]}};this.addItems=function(t){if(!t){return}for(var r=0,q=t.length;r<q;r++){o.addItem(t[r])}};this.updateItems=function(t){if(!t){return}for(var r=0,q=t.length;r<q;r++){o.updateItem(t[r])}};this.removeItems=function(t){if(!t){return}for(var r=0,q=t.length;r<q;r++){o.removeItem(t[r])}};o.init()};var OrderTableControl=function(d){var b=true;var c=null;var a={langs:{"zh-cn":{ajax:{loading:"加载中",error:"加载错误"},pagination:{first:"<<",first_title:"跳转到首页",last:">>",last_title:"跳转到尾页",prev:"<",prev_title:"跳转到上一页",next:">",next_title:"跳转到下一页"}}},locale:"zh-cn",placeholder:"没有数据",fitColumns:true,resizableColumns:false,history:false,movableColumns:false,tooltipsHeader:true,tooltips:true,selectable:1,pagination:"local",columnVertAlign:"bottom",columns:[{title:"序号",field:"num",width:60},{title:"订单编号",field:"id"}]};this.tableConfig=function(){return a};this.init=function(j){var g=this;a.rowClick=function(k,l){var i=$("#table").tabulator("getSelectedData");i=i.length>0?i[0]:null;if(i){g.selectRow(l.getData())}else{g.unselectRow(l.getData())}};for(var h=0,e=j.length;h<e;h++){j[h].num=h+1}$("#table").tabulator(a);$("#table").tabulator("setData",j);$("#table").tabulator("setPageSize",10);$("#table").tabulator("setPage",1);var f=document.getElementById("tableHeader");f.onmousedown=function(){var i=document.getElementById("tableOpenIcon");if(b){i.textContent="∨";$("#table").animate({height:"0px"},200)}else{i.textContent="∧";$("#table").animate({height:"308px"},200)}b=!b}};this.selectRow=function(f,e){if(!c){c=f}else{if(c&&c.id!==f.id){c=f}}d.addTransportTableControl(c,e)};this.unselectRow=function(e){c=null;d.removeTransportTableControl()}};var TransportTableControl=function(i,a,e){var j=this;this.defaultAnchor=BMAP_ANCHOR_TOP_LEFT;this.defaultOffset=new BMap.Size(15,370);var h=i;this.mapControl=function(k){if(!arguments.length){return h}h=k;return this};var d=null;this.contentDiv=function(k){if(!arguments.length){return d}d=k;return this};var f=a;this.data=function(k){if(!arguments.length){return f}f=k;return this};var c=e;this.callBack=function(k){if(!arguments.length){return c}c=k;return this};var b=null;this.selectedItem=function(k){if(!arguments.length){return b}b=k;return this};var g={placeholder:"没有数据",fitColumns:true,resizableColumns:false,history:false,movableColumns:false,tooltipsHeader:true,tooltips:true,selectable:1,columnVertAlign:"bottom",columns:[{title:"运单编号",field:"id"}]};this.tableConfig=function(){return g}};TransportTableControl.prototype=new BMap.Control();TransportTableControl.prototype.initialize=function(b){var a=this;var c=a.setContent(a.data(),true,a.callBack());$(c).on("mousewheel",function(d){d.stopPropagation()});b.getContainer().appendChild(c);return c};TransportTableControl.prototype.setContent=function(g,i,e){var a=this;a.data(g);var b=a.contentDiv();if(!b){b=document.createElement("div");b.setAttribute("id","transportTable_control");b.style.border="1px solid rgba(20,255,255,0.15)";b.style.color="#fff";b.style.backgroundColor="rgba(68,123,175,0.75)";b.style.padding="5px 5px 5px 5px";b.style.width="290px";a.contentDiv(b);var f='<div class="tl_border"></div><div class="tr_border"></div><div class="bl_border"></div><div class="br_border"></div><div id="transportTable"></div>';b.innerHTML=f}var c=setInterval(function(){if(document.getElementById("transportTable")){clearInterval(c);if(a.data()){if(i===true){a.addEventListeners();$("#transportTable").tabulator(a.tableConfig())}$("#transportTable").tabulator("setData",a.data())}else{$("#transportTable").tabulator("setData",[])}if(e){e.apply(null)}}},10);a.mapControl().resizeUI();b.style.display=a.data()?"block":"none";if(g&&g.length>0){var h=setTimeout(function(){clearTimeout(h);a.scrollToCheckPoint(0)},100)}return b};TransportTableControl.prototype.addEventListeners=function(){var a=this,b=a.data();a.tableConfig().rowClick=function(d,f){var c=$("#transportTable").tabulator("getSelectedData");c=c.length>0?c[0]:null;if(c){a.selectRow(f.getData())}else{a.unselectRow(f.getData())}}};TransportTableControl.prototype.selectRow=function(b){var a=this;if(!a.selectedItem()){a.selectedItem(b)}else{if(a.selectedItem()&&a.selectedItem().id!==b.id){a.mapControl().unselectItem(a.selectedItem().id);a.selectedItem(b)}}a.mapControl().selectItem(a.selectedItem().id,true,true)};TransportTableControl.prototype.unselectRow=function(b){var a=this;a.selectedItem(null);a.mapControl().unselectItem(b.id)};TransportTableControl.prototype.scrollToCheckPoint=function(b){return;try{var f=$("#transportTable .play_icon");if(b<0){b=0}else{if(b>f.length-1){b=f.length-1}}for(var c=0,a=f.length;c<a;c++){if(c===b){f[c].setAttribute("class","play_icon check_point_arrow")}else{f[c].setAttribute("class","play_icon check_point_arrow_hide")}}s=f.eq(b).offset().top-f.eq(0).offset().top;if(s>0){s+=10}$("#transportTable").animate({scrollTop:s},200)}catch(d){console.log(d)}};var ObjectUtil={cloneObj:function(c){var d,b=c.constructor===Array?[]:{};if(typeof c!=="object"){return}else{if(window.JSON){d=JSON.stringify(c),b=JSON.parse(d)}else{for(var a in c){b[a]=typeof c[a]==="object"?cloneObj(c[a]):c[a]}}}return b},getQueryString:function(a){var b=new RegExp("(^|&)"+a+"=([^&]*)(&|$)");var c=window.location.search.substr(1).match(b);if(c!=null){return unescape(c[2])}return null},filterObj:function(d,b,a){if(a===undefined){a=""}if(!d){return a}var c=d[b];return c===undefined||c===null?a:c}};Date.prototype.Format=function(a){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(a)){a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var b in c){if(new RegExp("("+b+")").test(a)){a=a.replace(RegExp.$1,(RegExp.$1.length==1)?(c[b]):(("00"+c[b]).substr((""+c[b]).length)))}}return a};