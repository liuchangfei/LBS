var BMapLib=window.BMapLib=BMapLib||{};(function(){var g=function(p,o,m){o=b(o);var q=p.pointToPixel(o.getNorthEast());var l=p.pointToPixel(o.getSouthWest());q.x+=m;q.y-=m;l.x-=m;l.y+=m;var k=p.pixelToPoint(q);var n=p.pixelToPoint(l);return new BMap.Bounds(n,k)};var b=function(l){var n=a(l.getNorthEast().lng,-180,180);var k=a(l.getSouthWest().lng,-180,180);var m=a(l.getNorthEast().lat,-74,74);var o=a(l.getSouthWest().lat,-74,74);return new BMap.Bounds(new BMap.Point(k,o),new BMap.Point(n,m))};var a=function(l,m,k){m&&(l=Math.max(l,m));k&&(l=Math.min(l,k));return l};var d=function(k){return"[object Array]"===Object.prototype.toString.call(k)};var j=function(k){return"[object Object]"===Object.prototype.toString.call(k)};var f=function(o,p){var l=-1;if(d(p)){if(p.indexOf){l=p.indexOf(o)}else{for(var n=0,k;k=p[n];n++){if(k===o){l=n;break}}}}return l};var h=function(k,l){if(!k){return""}return k.length>l?k.substring(0,l)+"...":k};var e=BMapLib.MarkerClusterer=function(o,k){if(!o){return}this._map=o;this._markers=[];this._clusters=[];this._isObjectData=false;var m=k||{};this._gridSize=m.gridSize||60;this._maxZoom=m.maxZoom||18;this._minClusterSize=m.minClusterSize||2;this._isAverageCenter=false;if(m.isAverageCenter!=undefined){this._isAverageCenter=m.isAverageCenter}this._styles=m.styles||[];var n=m.data;this._data=n;if(d(n)){this.addMarkers(n)}else{if(j(n)){this._isObjectData=true;this.redrawData()}}var l=this;this._map.addEventListener("zoomend",function(p){l._isObjectData?l.redrawData():l._redraw()});this._map.addEventListener("moveend",function(){l._isObjectData?l.redrawData():l._redraw()})};e.prototype.redrawData=function(){this._map.clearOverlays();var k=this._map.getZoom();if(k<=7){this.addProvinceMarkers()}else{if(k<=12){this.addCityMarkers()}else{this.addItemMarkers()}}};e.prototype.getIcon=function(n,l,k){var m;if(l&&l.length>1){l=new BMap.Size(l[0],l[1]);m=new BMap.Icon(n,l);m.setImageSize(l);if(k&&k.length>1){m.setAnchor(new BMap.Size(k[0],k[1]))}}return m};e.prototype.addProvinceMarkers=function(){var k=this._map;var m=this._data;var q=m.provinceItems;var r=this.getIcon("assets/images/circle_green.png",[72,72],[72/2,72/2]);var p={backgroundColor:"none",color:"#fff",font:"微软雅黑",fontSize:"13px",border:"none"};for(var n=0,o=q.length;n<o;n++){var t=q[n];var u=new BMap.Point(t.lng,t.lat);var l=new BMap.Marker(u);l.setIcon(r);l.setTitle("省份："+t.name+"\n数量："+t.count);var s=new BMap.Label("<div style='text-align:center;width:72px;height:49px;padding-top:19px;'>"+h(t.name,4)+"<br/>"+t.count+"</div>");s.setStyle(p);l.setLabel(s);k.addOverlay(l)}};e.prototype.addCityMarkers=function(){var k=this._map;var m=this._data;var q=m.cityItems;var r=this.getIcon("assets/images/circle_orange.png",[72,72],[72/2,72/2]);var p={backgroundColor:"none",color:"#fff",font:"微软雅黑",fontSize:"13px",border:"none"};for(var n=0,o=q.length;n<o;n++){var t=q[n];var u=new BMap.Point(t.lng,t.lat);var l=new BMap.Marker(u);l.setIcon(r);l.setTitle("城市："+t.name+"\n数量："+t.count);var s=new BMap.Label("<div style='text-align:center;width:72px;height:49px;padding-top:19px;'>"+h(t.name,4)+"<br/>"+t.count+"</div>");s.setStyle(p);l.setLabel(s);k.addOverlay(l)}};e.prototype.addItemMarkers=function(){var r=this._map;var p=this._data;var m=p.items;for(var n=0,k=m.length;n<k;n++){var o=m[n];var q=new BMap.Point(o.lng,o.lat);var l=new BMap.Marker(q);l.setTitle("机房："+o.name+"\n地址："+o.province+o.city);r.addOverlay(l)}};e.prototype.addMarkers=function(m){for(var l=0,k=m.length;l<k;l++){this._pushMarkerTo(m[l])}this._createClusters()};e.prototype._pushMarkerTo=function(k){var l=f(k,this._markers);if(l===-1){k.isInCluster=false;this._markers.push(k)}};e.prototype.addMarker=function(k){this._pushMarkerTo(k);this._createClusters()};e.prototype._createClusters=function(){var l=this._map.getBounds();var n=g(this._map,l,this._gridSize);for(var m=0,k;k=this._markers[m];m++){if(!k.isInCluster&&n.containsPoint(k.getPosition())){this._addToClosestCluster(k)}}this.updateAllClusters()};e.prototype._addToClosestCluster=function(p){var m=4000000;var l=null;var q=p.getPosition();var n=this._map;var s=this._clusters;for(var o=0,t;t=s[o];o++){var k=t.getCenter();if(k){var r=n.getDistance(k,q);if(r<m){m=r;l=t}}}if(l&&l.isMarkerInClusterBounds(p)){l.addMarker(p)}else{var t=new c(this);t.addMarker(p);this._clusters.push(t)}};e.prototype._clearLastClusters=function(){for(var l=0,k;k=this._clusters[l];l++){k.remove()}this._clusters=[];this._removeMarkersFromCluster()};e.prototype._removeMarkersFromCluster=function(){for(var l=0,k;k=this._markers[l];l++){k.isInCluster=false}};e.prototype._removeMarkersFromMap=function(){for(var l=0,k;k=this._markers[l];l++){k.isInCluster=false;this._map.removeOverlay(k)}};e.prototype._removeMarker=function(k){var l=f(k,this._markers);if(l===-1){return false}this._map.removeOverlay(k);this._markers.splice(l,1);return true};e.prototype.removeMarker=function(k){var l=this._removeMarker(k);if(l){this._clearLastClusters();this._createClusters()}return l};e.prototype.removeMarkers=function(n){var m=false;for(var k=0;k<n.length;k++){var l=this._removeMarker(n[k]);m=m||l}if(m){this._clearLastClusters();this._createClusters()}return m};e.prototype.clearMarkers=function(){this._clearLastClusters();this._removeMarkersFromMap();this._markers=[]};e.prototype._redraw=function(){this._clearLastClusters();this._createClusters()};e.prototype.getGridSize=function(){return this._gridSize};e.prototype.setGridSize=function(k){this._gridSize=k;this._redraw()};e.prototype.getMaxZoom=function(){return this._maxZoom};e.prototype.setMaxZoom=function(k){this._maxZoom=k;this._redraw()};e.prototype.getStyles=function(){return this._styles};e.prototype.setStyles=function(k){this._styles=k;this._redraw()};e.prototype.getMinClusterSize=function(){return this._minClusterSize};e.prototype.setMinClusterSize=function(k){this._minClusterSize=k;this._redraw()};e.prototype.isAverageCenter=function(){return this._isAverageCenter};e.prototype.getMap=function(){return this._map};e.prototype.getMarkers=function(){return this._markers};e.prototype.getClustersCount=function(){var m=0;for(var l=0,k;k=this._clusters[l];l++){k.isReal()&&m++}return m};e.prototype.updateAllClusters=function(){for(var l=0,k;k=this._clusters[l];l++){k.updateClusterMarker()}};function c(k){this._markerClusterer=k;this._map=k.getMap();this._minClusterSize=k.getMinClusterSize();this._isAverageCenter=k.isAverageCenter();this._center=null;this._markers=[];this._gridBounds=null;this._isReal=false;this._clusterMarker=new BMapLib.TextIconOverlay(this._center,this._markers.length,{styles:this._markerClusterer.getStyles()})}c.prototype.addMarker=function(n){if(this.isMarkerInCluster(n)){return false}if(!this._center){this._center=n.getPosition();this.updateGridBounds()}else{if(this._isAverageCenter){var m=this._markers.length+1;var q=(this._center.lat*(m-1)+n.getPosition().lat)/m;var o=(this._center.lng*(m-1)+n.getPosition().lng)/m;this._center.lng=o;this._center.lat=q;this.updateGridBounds()}}n.isInCluster=true;this._markers.push(n);var k=this._markers.length;if(k<this._minClusterSize){this._map.addOverlay(n);return true}else{if(k===this._minClusterSize){for(var p=0;p<k;p++){this._markers[p].getMap()&&this._map.removeOverlay(this._markers[p])}}}this._map.addOverlay(this._clusterMarker);this._isReal=true;return true};c.prototype.isMarkerInCluster=function(l){if(this._markers.indexOf){return this._markers.indexOf(l)!=-1}else{for(var n=0,k;k=this._markers[n];n++){if(k===l){return true}}}return false};c.prototype.isMarkerInClusterBounds=function(k){return this._gridBounds.containsPoint(k.getPosition())};c.prototype.isReal=function(k){return this._isReal};c.prototype.updateGridBounds=function(){var k=new BMap.Bounds(this._center,this._center);this._gridBounds=g(this._map,k,this._markerClusterer.getGridSize())};var i=this;c.prototype.updateClusterMarker=function(){if(this._map.getZoom()>this._markerClusterer.getMaxZoom()){this._clusterMarker&&this._map.removeOverlay(this._clusterMarker);for(var n=0,l;l=this._markers[n];n++){this._map.addOverlay(l)}return}if(this._markers.length<this._minClusterSize){this._clusterMarker.hide();return}this._clusterMarker.setPosition(this._center);this._clusterMarker.setText(this._markers.length);var m=this._map;var k=this.getBounds();this._clusterMarker.onclick=function(){m.setViewport(k)}};c.prototype.remove=function(){for(var l=0,k;k=this._markers[l];l++){this._markers[l].getMap()&&this._map.removeOverlay(this._markers[l])}this._map.removeOverlay(this._clusterMarker);this._markers.length=0;delete this._markers};c.prototype.getBounds=function(){var m=new BMap.Bounds(this._center,this._center);for(var l=0,k;k=this._markers[l];l++){m.extend(k.getPosition())}return m};c.prototype.getCenter=function(){return this._center}})();