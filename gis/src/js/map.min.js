var MapControl=function(j,b){var n=this,c={},d={},i={};var m=j===true;this.isAdmin=function(v){if(!arguments.length){return m}m=v;return this};var t=b?b:"midnight";this.mapStyle=function(v){if(!arguments.length){return t}t=v;return this};var u=new BMap.Map("map",{enableMapClick:!1});this.map=function(v){if(!arguments.length){return u}u=v;return this};var k={};this.tracksInfo=function(v){if(!arguments.length){return k}k=v;return this};this.trackMap=function(){return d};var q=new BMap.Geocoder();this.geoc=function(v){if(!arguments.length){return q}q=v;return this};this.parseAddr=function(v,x,w){n.geoc().getPoint(v[x].addr,function(y){if(v[x].posObj){v[x].posObj.pos=[y.lng,y.lat]}x++;if(x>=v.length){n.initContent(w);return}n.parseAddr(v,x,w)})};this.parseAddrList=function(v,w){n.parseAddr(v,0,w)};this.init=function(E){var v=[];for(var G,x,J=0,K=E.length;J<K;J++){var F=E[J];var O=F.id;if(O&&O.indexOf("@")){F.id=O.replace("@","_")}var M;if(F.currentPos){M=F.currentPos.time;x=F.currentPos.pos;if(x&&x.length===2){x[0]=parseFloat(x[0]);x[1]=parseFloat(x[1])}}G=F.dispatchData;if(G){var N=false;F.posList=[];for(var I=0,B=G.length;I<B;I++){var A=G[I];x=A.startPos.pos;if(x&&x.length===2){x[0]=parseFloat(x[0]);x[1]=parseFloat(x[1])}else{v.push({addr:A.startPos.address,posObj:A.startPos})}if(I===0){F.startPos=A.startPos}if(I===B-1){F.endPos=A.endPos}x=A.endPos.pos;if(x&&x.length===2){x[0]=parseFloat(x[0]);x[1]=parseFloat(x[1])}else{v.push({addr:A.endPos.address,posObj:A.endPos})}var D=A.posList;if(D){var w,y,L,C;for(var H=0,z=D.length;H<z;H++){w=D[H];if(!N){y=w.time;C=H+1;L=C>z-1?D[z-1].time:D[C].time;if(M>=y&&M<=L){F.portraitUrl=A.portraitUrl;F.name=A.name;F.tel=A.tel;F.driveTime=A.driveTime;F.carNumber=A.carNumber;F.company=A.company;F.consignor=A.consignor;F.consignee=A.consignee;F.containerTemp=A.containerTemp;F.outdoorTemp=A.outdoorTemp;F.sectionId=A.id;F.isTemp=A.isTemp;N=true}}x=w.pos;if(x&&x.length===2){x[0]=parseFloat(x[0]);x[1]=parseFloat(x[1])}F.posList.push(w)}}}}}if(v.length>0){n.parseAddrList(v,E)}else{n.initContent(E)}};this.initContent=function(v){n.tracksInfo(v);u.centerAndZoom(new BMap.Point(116.404,39.915),12);u.enableScrollWheelZoom(true);u.setMapStyle({style:n.mapStyle()});n.initControl(v);n.initOverlay();n.addListeners();n.addCars(v);n.initLocation(v);var w=setTimeout(function(){clearTimeout(w);$(".init-loading").css("display","none");$("#map").animate({opacity:1});$("#tableCon").animate({opacity:1})},1000)};this.initLocation=function(x){var z=[];for(var y=0,v=x.length;y<v;y++){var w=x[y];if(!w.currentPos||!w.currentPos.pos||w.currentPos.pos.length!==2){continue}var B=w.currentPos.pos;z.push(new BMap.Point(B[0],B[1]))}if(z.length>1){u.setViewport(z)}else{if(z.length===1){u.setCenter(z[0]);u.setZoom(10)}else{var A=new BMap.LocalCity();A.get(function(C){var D=C.name;u.setCenter(D)})}}};this.initControl=function(v){n.addCityListControl();n.addNavigationControl();n.addScaleControl();n.addMapTypeControl();n.addInfoControl();n.addRouteControl();n.addTableControl(v);n.addTreeControl()};this.initOverlay=function(){};this.addListeners=function(){window.addEventListener("resize",n.resizeUI)};this.resizeUI=function(){var v=n.treeControl;if(v){var x=$("#map").outerHeight(true)-20;var z=380;var w=x-z<0?0:x-z;$("#tree_control").css("height",w+"px");$("#sectionsTree").css("height",(w-30)+"px");v.setOffset(BMap.Size(15,z))}};this.addCityListControl=function(){n.cityListControl=new BMap.CityListControl({anchor:BMAP_ANCHOR_TOP_LEFT,offset:new BMap.Size(320,10)});u.addControl(n.cityListControl);n.cityListControl.hide()};this.removeCityListControl=function(){u.removeControl(n.cityListControl)};this.addNavigationControl=function(){n.navigationControl=new BMap.NavigationControl({type:BMAP_NAVIGATION_CONTROL_ZOOM,anchor:BMAP_ANCHOR_TOP_RIGHT,offset:new BMap.Size(10,12)});u.addControl(n.navigationControl)};this.removeNavigationControl=function(){u.removeControl(n.navigationControl)};this.addScaleControl=function(){n.scaleControl=new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,offset:new BMap.Size(100,10)});u.addControl(n.scaleControl)};this.removeScaleControl=function(){u.removeControl(n.scaleControl)};this.addMapTypeControl=function(){n.mapTypeControl=new BMap.MapTypeControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,offset:new BMap.Size(10,10),mapTypes:[BMAP_NORMAL_MAP,BMAP_HYBRID_MAP]});u.addControl(n.mapTypeControl)};this.removeMapTypeControl=function(){u.removeControl(n.mapTypeControl)};this.addInfoControl=function(){n.infoControl=new InfoControl();u.addControl(n.infoControl);n.infoControl.hide()};this.removeInfoControl=function(){u.removeControl(n.infoControl)};this.addRouteControl=function(){n.routeControl=new RouteControl(n,null,n.isAdmin());u.addControl(n.routeControl);n.routeControl.hide()};this.removeRouteControl=function(){u.removeControl(n.routeControl)};this.addTableControl=function(v){n.tableControl=new TableControl(n);n.tableControl.init(v);if(!isMutilMode){n.tableControl.selectRow(v[0])}};this.removeTableControl=function(){};this.addTreeControl=function(v){n.treeControl=new TreeControl(this);u.addControl(n.treeControl)};this.removeTreeControl=function(){u.removeControl(n.treeControl);n.treeControl=null};this.addTempControl=function(v){if(!n.tempControl){n.tempControl=new TempControl(v,this);u.addControl(n.tempControl)}};this.removeTempControl=function(){if(n.tempControl){u.removeControl(n.tempControl);n.tempControl=null}};var h=function(v,y,x){var w=new BMap.Geocoder();if(isNaN(y)){y=3}else{if(y>4){y=4}else{if(y<0){y=0}}}w.getLocation(v,function(z){var B=z.addressComponents;var A;if(y===0){A=B.province}else{if(y===1){A=B.city}else{if(y===2){A=B.city+B.district}else{if(y===3){A=B.city+B.district+B.street}else{A=B.city+B.district+B.street+B.streetNumber}}}}if(B.province!==B.city){A=B.province+A}if(x){x.call(null,A)}})};var f=function(v,D,x,z,A,w,C,B,y){return'<svg id="info_window_svg_'+v+'" verson="1.1" style="position:absolute;width:50px;height:200px;pointer-events:none;"><polyline points="0,195 25,50 50,50" style="stroke:rgba(68,123,175,0.75);stroke-width:2;fill:none;"/></svg><div id="info_window_content_'+v+'" class="info_window_content"><div class="tl_border"></div><div class="tr_border"></div><div class="bl_border"></div><div class="br_border"></div><div><span style="padding-left:0px;">运单编号：</span>'+ObjectUtil.getOrinId(v)+'</div><div><span style="padding-left:0px;">装车单号：</span>'+D+'</div><div><span style="padding-left:26px;">状态：</span>'+x+'</div><div><span style="padding-left:0px;">当前位置：</span>'+z+'</div><div><span style="padding-left:0px;">当前定位：</span>'+(A.join?A.join(" , "):A)+'</div><div><span style="padding-left:0px;">当前时间：</span>'+w+"</div></div>"+(y===true?('<svg id="temp_window_svg_'+v+'" verson="1.1" style="position:absolute;width:50px;height:100px;top:200px;pointer-events:none;"><polyline points="0,0 25,45 50,45" style="stroke:rgba(68,123,175,0.75);stroke-width:2;fill:none;"/></svg><div id="temp_window_content_'+v+'" class="temp_window_content"><div class="tl_border"></div><div class="tr_border"></div><div class="bl_border"></div><div class="br_border"></div><div id="temp_chart_'+v+'" class="chart" title="点击查看具体信息"></div><div id="temp_chart_con_'+v+'" style="display:block;width:200px;height:60px;margin-left:20px;"></div><div id="temp_chart_pre_'+v+'" class="chartPreBtn" title="向前查看"></div><div id="temp_chart_next_'+v+'" class="chartNextBtn" title="向后查看"></div></div>'):"")};var r=function(v,I,A,D,y,z,w,C,x,H,F,G,E,B){return"运单编号："+ObjectUtil.getOrinId(v)+"\n装车单号："+I+"\n状态："+A+"\n当前位置："+D+"\n当前时间："+y+"\n运单时间："+z+"\n发货人："+w+"\n发货地址："+C+"\n收货人："+x+"\n收货地址："+H+"\n运输类型："+F+(B===true?("\n货柜温度："+G+"\n室外温度："+E):"")};var o=function(v,A){var w;switch(v){case"离线":w="othertypeoffline";break;case"静止":w="othertypestatic";break;default:w="othertype";break}var z="assets/images/"+(A?w+"_lushu":w)+".png";var x=A?new BMap.Size(54*0.6,44*0.6):new BMap.Size(44*0.6,54*0.6);var y=new BMap.Icon(z,x);y.setImageSize(x);return y};var g=function(y,w,v){var x;if(w&&w.length>1){w=new BMap.Size(w[0],w[1]);x=new BMap.Icon(y,w);x.setImageSize(w);if(v&&v.length>1){x.setAnchor(new BMap.Size(v[0],v[1]))}}return x};var a=function(x,y){if(!x||x.length===0){return null}if(!y){var w=o(null,true);y={landmarkPois:[],speed:5000,icon:w,autoView:false,enableRotation:false}}var v=new BMapLib.LuShu(u,x,y);v.treeControl(n.treeControl);return v};var p=function(x){var w=d3.transition().duration(500).delay(500).ease(d3.easeExpOut);var v=d3.transition().duration(200).delay(100).ease(d3.easeExpOut);d3.select("#info_window_content_"+x).style("opacity",0).style("transform","translate(100px, 0px)");d3.select("#info_window_svg_"+x).style("transform-origin","left bottom").style("transform","scale(0, 0)").transition(w).style("transform","scale(1, 1)").on("end",function(){d3.select("#info_window_content_"+x).transition(v).style("opacity",1).style("transform","translate(0px, 0px)")});d3.select("#temp_window_content_"+x).style("opacity",0).style("transform","translate(100px, 0px)");d3.select("#temp_window_svg_"+x).style("transform-origin","left top").style("transform","scale(0, 0)").transition(w).style("transform","scale(1, 1)").on("end",function(){d3.select("#temp_window_content_"+x).transition(v).style("opacity",1).style("transform","translate(0px, 0px)")})};this.getValueByKey=function(v,w){return w?w[v]:null};this.getLuShuById=function(w){var v=n.getValueByKey(w,d);if(!v){return null}return v.lushu};this.visibleCar=function(y,x){var w=n.getValueByKey(y,c);if(!w){return}var v=w.car;if(v){x?v.show():v.hide()}};this.selectCar=function(v,w,E){var y=n.getValueByKey(v,c);if(!y){return}var C=y.car;var x=y.infoWindow;C.setTop(true);x.show();p(v);var z=y.data;var A=ObjectUtil.filterObj(z.currentPos,"pos");var B=new BMap.Point(A[0],A[1]);if(w){u.panTo(B)}if(E){u.setZoom(14)}var D=n.infoControl;D.setContent(z);if(!D.isVisible()){D.show()}n.resizeUI()};this.addCar=function(W,R,v){var M=ObjectUtil.filterObj(W,"id");var S=c[M]?true:false;var K=ObjectUtil.filterObj(W,"sectionId","未知");var z=ObjectUtil.filterObj(W.currentPos,"pos","未知");var E=ObjectUtil.filterObj(W.currentPos,"address","未知");var P=ObjectUtil.filterObj(W,"status","未知");var B=ObjectUtil.filterObj(W.currentPos,"time","未知");var L=ObjectUtil.filterObj(W.posList?W.posList[0]:null,"time").split(" ")[0];var G=ObjectUtil.filterObj(W,"consignor","未知");var N=ObjectUtil.filterObj(W.startPos,"address","未知");var A=ObjectUtil.filterObj(W,"consignee","未知");var y=ObjectUtil.filterObj(W.endPos,"address","未知");var F=ObjectUtil.filterObj(W,"transportType","未知");var V=ObjectUtil.filterObj(W,"containerTemp","未知");var x=ObjectUtil.filterObj(W,"outdoorTemp","未知");var T=ObjectUtil.filterObj(W,"isTemp",false)===1;var O=new BMap.Point(z[0],z[1]);var D=S?c[M].car:new BMap.Marker();D.setPosition(O);var C=o(P);var Y=r(M,K,P,E,B,L,G,N,A,y,F,V,x,T);D.setTitle(Y);D.setIcon(C);if(R){u.setZoom(14);u.panTo(O)}var I=f(M,K,P,E,z,B,V,x,T);var U=S?c[M].infoWindow:new BMap.Label(I);U.setOffset(new BMap.Size(10,-185));U.setStyle({padding:"0px","background-color":"rgba(0,0,0,0)","border-color":"rgba(0,0,0,0)",color:"#fff","font-size":"13px","font-family":"微软雅黑 宋体"});U.hide();D.setLabel(U);c[M]={car:D,data:W,infoWindow:U};var H=W.posList;if(H&&H.length>1){var Q=H[H.length-2].pos;Q=u.pointToPixel(new BMap.Point(Q[0],Q[1]));var X=H[H.length-1].pos;X=u.pointToPixel(new BMap.Point(X[0],X[1]));var J=Math.atan2(X.y-Q.y,X.x-Q.x)*180/Math.PI+90;c[M].car.setRotation(J)}if(S){U.setContent(I);U.draw();e(M)}else{u.addOverlay(D);D.addEventListener("click",function(){var ad=$("#table");var ac=ad.tabulator("getData");var aa=0;for(var ab=0,Z=ac.length;ab<Z;ab++){if(ac[ab].id===M){aa=ab;break}}var ae=Math.floor(aa/10)+1;ad.tabulator("setPage",ae);ad.tabulator("selectRow",M);var af=ad.tabulator("getSelectedData");af=af.length>0?af[0]:null;if(isMutilMode){if(af.hasOwnProperty("plan")){n.tableControl.selectRow(af)}else{n.tableControl.loadRowData(af)}}else{n.tableControl.selectRow(af)}})}$("#table").tabulator("updateData",[W]);I=f(M,K,P,E,z,B,V,x,T);var w=c[M].infoWindow;w.setContent(I);w.draw();Y=r(M,K,P,E,B,L,G,N,A,y,F,V,x,T);D.setTitle(Y);if(v){U.show();p(M)}$("#table").tabulator("updateData",[W])};var l=function(w){if(!d[w]){return}if(!i[w]){i[w]={}}var v=setInterval(function(){var y=d3.select("#temp_chart_con_"+w).node();if(y&&y.clientWidth>0&&y.clientHeight>0){clearInterval(v);var A="temp_chart_con_"+w;var x=d[w].data.tempIns;x.lineConfig().axis.yAxis[0].tick.tickArguments=[2];x.lineConfig().axis.xAxis[0].tick.tickFormat=function(B){return d3.timeFormat("%H:%M")(B.getTime())};var z=new ghca_charts.view.graph(A,x.lineConfig());z.render();i[w].chart=z}},10)};var e=function(y){if(!i[y]){i[y]={}}i[y].isOpen=false;var w="temp_chart_con_"+y;var x="temp_chart_pre_"+y;var v="temp_chart_next_"+y;$("#temp_chart_"+y).on("click",function(){var z=i[y].isOpen===true;i[y].isOpen=!z;if(z){$("#"+x).css("display","none");$("#"+v).css("display","none");$("#"+w).animate({width:"200px",height:"60px"},200,"swing",function(){var A=i[y].chart;A.setConfigProperty("axis.yAxis[0].tick.tickArguments",[2]);A.setConfigProperty("axis.xAxis[0].tick.tickFormat",function(B){return d3.timeFormat("%H:%M")(B.getTime())});A.update();A.resize()})}else{$("#"+w).animate({width:"350px",height:"200px"},200,"swing",function(){var B=i[y].chart;var A=d[y].data.tempIns;B.setConfigProperty("axis.yAxis[0].tick.tickArguments",[5]);B.setConfigProperty("axis.xAxis[0].tick.tickFormat",function(C){return d3.timeFormat("%m-%d %H:%M")(C.getTime())});B.update();B.resize();n.validatePageBtn(y,A)})}});$("#"+x).on("click",function(){var A=i[y].chart;var z=d[y].data.tempIns;var B=z.getPrePageTempData();n.validatePageBtn(y,z);A.setData({data:B[0]},0);A.setData({data:B[1]},1);A.update()});$("#"+v).on("click",function(){var A=i[y].chart;var z=d[y].data.tempIns;var B=z.getNextPageTempData();n.validatePageBtn(y,z);A.setData({data:B[0]},0);A.setData({data:B[1]},1);A.update()})};this.validatePageBtn=function(y,v){var x="temp_chart_pre_"+y;var w="temp_chart_next_"+y;$("#"+x).css("display",v.tempPage()===0?"none":"block");$("#"+w).css("display",v.tempPage()===v.tempTotalPage()?"none":"block")};this.updateCar=function(v){n.addCar(v)};this.removeCar=function(w){var v=c[w];if(v){u.removeOverlay(v.car);delete c[w]}};this.addCars=function(x){if(!x){return}for(var w=0,v=x.length;w<v;w++){n.addCar(x[w])}};this.updateCars=function(x){if(!x){return}for(var w=0,v=x.length;w<v;w++){n.updateCar(x[w])}};this.removeCars=function(x){if(!x){return}for(var w=0,v=x.length;w<v;w++){n.removeCar(x[w])}};this.selectTrack=function(y,x){var w=n.getValueByKey(y,d);if(!w){return}var v=x?(w.planPoints?w.planPoints:[w.startPoint,w.endPoint]):w.points;u.setViewport(v)};this.addTrack=function(ae,z){var U=ObjectUtil.filterObj(ae,"id");var w=d[U];var Q=w?true:false;var H=ae.posList;var W=[];for(var ad=0,F=H.length;ad<F;ad++){var K=H[ad];var P=K.pos;W.push(new BMap.Point(P[0],P[1]))}var X=ae.dispatchData;var Z=[];for(var J,ad=0,F=X.length;ad<F;ad++){var af=[];J=X[ad];H=J.posList;for(var P,ac=0,A=H.length;ac<A;ac++){P=H[ac].pos;af.push(new BMap.Point(P[0],P[1]))}Z.push(af)}var x=ae.startPos;var M=new BMap.Point(x.pos[0],x.pos[1]);var C=Q?w.startMarker:new BMap.Marker();C.setPosition(M);if(!Q){var O=g("assets/images/start_marker.png",[29,33],[29/2,33]);C.setIcon(O);u.addOverlay(C)}C.setTitle("[起点]\n运单编号："+U+"\n地址："+x.address);var G=ae.endPos;var y=new BMap.Point(G.pos[0],G.pos[1]);var D=Q?w.endMarker:new BMap.Marker();D.setPosition(y);if(!Q){var Y=g("assets/images/end_marker.png",[29,32],[29/2,32]);D.setIcon(Y);u.addOverlay(D)}D.setTitle("[终点]\n运单编号："+U+"\n地址："+G.address);if(!Q||!M.equals(w.startPoint)||!y.equals(w.endPoint)){var T=ae.plan;var aa=T.path;var E=[];for(var ad=0;ad<aa.length;ad++){var P=aa[ad];E.push(new BMap.Point(P[0],P[1]))}var S=new BMap.Polyline(E,{strokeColor:"#4caf50",strokeWeight:5,strokeOpacity:0.8});u.addOverlay(S);var v=d[U];if(v){v.planPoints=E;v.planPath=S}}var I=Q?w.track:new BMap.Polyline(W,{strokeColor:"rgba(0,0,0,0)",strokeWeight:5,strokeOpacity:0.8});var L;if(Q){L=w.sectionTracks}else{L=[];for(var ad=0,F=Z.length;ad<F;ad++){L.push(new BMap.Polyline(Z[ad],{strokeColor:ColorUtil.getColor(ad),strokeWeight:5,strokeOpacity:0.8}))}}if(Q){I.setPath(W);for(var ad=0,F=L.length;ad<F;ad++){L[ad].setPath(Z[ad])}}else{u.addOverlay(I);for(var ad=0,F=L.length;ad<F;ad++){u.addOverlay(L[ad])}}n.routeControl.checkPath(ae,true);var x=ae.startPos.pos;var G=ae.endPos.pos;var B=o(ae.status,true);var V=ae.posList;var ab=[];for(var ad=0;ad<V.length;ad++){var R=V[ad];ab.push({lng:R.pos[0],lat:R.pos[1],html:'<div style="font-size:13px;font-family:微软雅黑 宋体;"><div style="text-align:left;">到达地点：'+R.address+'</div><div style="text-align:left;">到达时间：'+(R.time?R.time:"未知")+"</div></div>",pauseTime:2})}var N={landmarkPois:ab,defaultContent:"运单编号:"+ObjectUtil.getOrinId(U),speed:5000,icon:B,autoView:true,enableRotation:true};var ag=a(W,N);n.addCar(ae);if(z){u.setViewport([M,y])}if(Q){w.points=W;w.lushu=ag;w.startPoint=M;w.endPoint=y}else{new Temp().create(ae);d[U]={track:I,sectionTracks:L,startMarker:C,endMarker:D,data:ae,points:W,lushu:ag,startPoint:M,endPoint:y,planPoints:E,planPath:S}}e(U);l(U)};this.updateTrack=function(v){n.addTrack(v)};this.removeTrack=function(y){var x=d[y];if(x){n.destroy(y);u.removeOverlay(x.track);if(x.sectionTracks){for(var w=0,v=x.sectionTracks.length;w<v;w++){u.removeOverlay(x.sectionTracks[w])}}u.removeOverlay(x.planPath);u.removeOverlay(x.startMarker);u.removeOverlay(x.endMarker);n.removeCar(y);delete d[y]}};this.addTracks=function(x){if(!x){return}for(var w=0,v=x.length;w<v;w++){n.addTrack(x[w])}};this.updateTracks=function(x){if(!x){return}for(var w=0,v=x.length;w<v;w++){n.updateTrack(x[w])}};this.removeTracks=function(x){if(!x){return}for(var w=0,v=x.length;w<v;w++){n.removeTrack(x[w])}};this.start=function(w){var v=n.getLuShuById(w);if(v){n.visibleCar(w,false);v.start()}};this.pause=function(w){var v=n.getLuShuById(w);if(v){v.pause()}};this.stop=function(w){var v=n.getLuShuById(w);if(v){n.visibleCar(w,true);n.selectCar(w,true);v.stop()}};this.destroy=function(w){var v=n.getLuShuById(w);if(v){v.destroy()}}};var InfoControl=function(b){this.defaultAnchor=BMAP_ANCHOR_TOP_RIGHT;this.defaultOffset=new BMap.Size(50,15);var d=b;this.data=function(e){if(!arguments.length){return d}d=e;return this};var a=null;this.contentDiv=function(e){if(!arguments.length){return a}a=e;return this};var c=false;this.isShowTable=function(e){if(!arguments.length){return c}c=e;return this}};InfoControl.prototype=new BMap.Control();InfoControl.prototype.initialize=function(b){var a=this;var c=a.setContent();b.getContainer().appendChild(c);return c};InfoControl.prototype.setContent=function(j){var q=this;q.data(j);var g=q.contentDiv();if(!g){g=document.createElement("div");g.setAttribute("id","info_control");g.style.border="1px solid rgba(20,255,255,0.15)";g.style.color="#fff";g.style.backgroundColor="rgba(68,123,175,0.75)";g.style.padding="5px 5px 5px 5px";q.contentDiv(g)}var a=j&&j.portraitUrl?j.portraitUrl:"http://i03.pic.sogou.com/2f6a423c0406a4fd";var c=ObjectUtil.filterObj(j,"name","未知");var n=ObjectUtil.filterObj(j,"driveTime","未知");var i=ObjectUtil.filterObj(j,"tel","未知");var m=ObjectUtil.filterObj(j,"carNumber","未知");var l=ObjectUtil.filterObj(j,"company","未知");var h=j?ObjectUtil.filterObj(j.posList[0],"time").split(" ")[0]:"未知";var e=ObjectUtil.filterObj(j,"consignor","未知");var k=j?ObjectUtil.filterObj(j.startPos,"address","未知"):"未知";var f=ObjectUtil.filterObj(j,"consignee","未知");var p=j?ObjectUtil.filterObj(j.endPos,"address","未知"):"未知";var o=ObjectUtil.filterObj(j,"transportType","未知");var b='<div class="tl_border"></div><div class="tr_border"></div><div class="bl_border"></div><div class="br_border"></div><div style="min-width:250px;font-size:13px;font-family:微软雅黑 宋体;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><img src='+a+' style="float:left;width:60px;height:60px;"/><div style="position:relative;width:auto;left:5px;padding-top:10px;"><div>姓名：'+c+"</div><div>驾龄："+n+"</div><div>车牌："+m+'</div></div><div><div><span style="padding-left:26px;">电话：</span>'+i+'</div><div><span style="padding-left:0px;">运输公司：</span>'+q.splitByLine(l,250,13,3,65)+'</div><div><span style="padding-left:0px;">运单时间：</span>'+q.splitByLine(h,250,13,3,65)+'</div><div><span style="padding-left:13px;">发货人：</span>'+q.splitByLine(e,250,13,3,65)+'</div><div><span style="padding-left:0px;">发货地址：</span>'+q.splitByLine(k,250,13,3,65)+'</div><div><span style="padding-left:13px;">收货人：</span>'+q.splitByLine(f,250,13,3,65)+'</div><div><span style="padding-left:0px;">收货地址：</span>'+q.splitByLine(p,250,13,3,65)+'</div><div><span style="padding-left:0px;">运输类型：</span>'+q.splitByLine(o,250,13,3,65)+'</div></div><div id="infoTableHeader"><div id="infoTableHeadText">货物信息</div><div id="infoTableOpenIcon">∨</div></div><div id="infoTable"></div></div>';g.innerHTML=b;var d=setInterval(function(){if($("#infoTableHeader").length>0){clearInterval(d);$("#infoTable").css("height",q.isShowTable()?"317px":"0px");q.addEventListeners();q.initTable(j?j.goods:null)}},10);return g};InfoControl.prototype.splitByLine=function(m,e,l,a,g){if(e==0||m==undefined){return m}var b=0,n=1;var o=[];var d=0,h=0;for(var j=0;j<m.length;j++){var c=m.charCodeAt(j);var f=c>255?l:l/2;b+=f;if(b>e){h=j;if(n===a){h>1?h-=2:h=1;o.push(m.substring(d,h)+"...");break}o.push(m.substring(d,h));d=j;b=0;n++}if(j===m.length-1){o.push(m.substring(d,m.length))}}g=isNaN(g)?0:g;for(var j=1,k=o.length;j<k;j++){if(k>=a){o[j]='<div style="padding-left:'+g+'px;" title="'+m+'">'+o[j]+"</div>"}else{o[j]='<div style="padding-left:'+g+'px;">'+o[j]+"</div>"}}return o.join("")};InfoControl.prototype.initTable=function(b){var c={"zh-cn":{ajax:{loading:"加载中",error:"加载错误"},pagination:{first:"<<",first_title:"跳转到首页",last:">>",last_title:"跳转到尾页",prev:"<",prev_title:"跳转到上一页",next:">",next_title:"跳转到下一页"}}};var a={langs:c,locale:"zh-cn",placeholder:"没有数据",fitColumns:true,resizableColumns:false,history:false,movableColumns:false,tooltipsHeader:true,tooltips:true,selectable:1,pagination:"local",columnVertAlign:"bottom",columns:[{title:"名称",field:"name",headerSort:false},{title:"厂家",field:"factory",width:90},{title:"数量",field:"number",width:70}]};$("#infoTable").tabulator(a);$("#infoTable").tabulator("setData",b);$("#infoTable").tabulator("setPageSize",10);$("#infoTable").tabulator("setPage",1)};InfoControl.prototype.addEventListeners=function(){var b=this;var a=document.getElementById("infoTableHeader");a.onmousedown=function(){var d=document.getElementById("infoTableOpenIcon");var c=b.isShowTable();if(c){d.textContent="∨";$("#infoTable").animate({height:"0px"},200)}else{d.textContent="∧";$("#infoTable").animate({height:"317px"},200)}b.isShowTable(!c)}};var RouteControl=function(j,c,k){var h=j;this.mapControl=function(m){if(!arguments.length){return h}h=m;return this};var g=c;this.data=function(m){if(!arguments.length){return g}g=m;return this};var i=k===true;this.isAdmin=function(m){if(!arguments.length){return i}i=m;return this};var d=null;this.contentDiv=function(m){if(!arguments.length){return d}d=m;return this};var a=null;this.map=function(m){if(!arguments.length){return a}a=m;return this};var e=null;this.driving=function(m){if(!arguments.length){return e}e=m;return this};var f=null;this.searchData=function(m){if(!arguments.length){return f}f=m;return this};var l=[];this.searchPath=function(m){if(!arguments.length){return l}l=m;return this};var b=new BMap.Geocoder();this.geoc=function(m){if(!arguments.length){return b}b=m;return this};this.initialize(j.map())};RouteControl.prototype.show=function(){var a=this;$(a.contentDiv()).css("display","block")};RouteControl.prototype.hide=function(){var a=this;$(a.contentDiv()).css("display","none")};RouteControl.prototype.initialize=function(b){var a=this;a.map(b);var d=new BMap.DrivingRoute(b,{renderOptions:{map:b,enableDragging:true,autoViewport:true}});a.driving(d);var c=a.setContent(a.data());$("#tableCon")[0].appendChild(c);a.show();a.mapControl().resizeUI();return c};RouteControl.prototype.getStrLinesNum=function(g,d,h){if(d===0){return 0}var b=0;for(var c=0,a=g.length;c<a;c++){var e=g.charCodeAt(c);var f=e>255?h:h/2;b+=f}return Math.ceil(b/d)};RouteControl.prototype.getPathDiv=function(i,k,h,d){var l=this;var j=i===0?"start_check_point_icon":i===1?"end_check_point_icon":"middle_check_point_icon";var e="";var f="";var c="";if(i!==0){c="margin-top:-5px;"}if(i!==1){var b=l.getStrLinesNum(h,253-41,13);var g=20*b;var a=15-b*20;e='<div style="width:0px;height:'+g+"px;margin-left:9px;margin-top:"+a+'px;border-left:solid rgba(20,255,255,0.5) 2px;"></div>'}if(k===0){f='<div title="未通过" style="width:16px;height:16px;float:left;margin-top:2px;margin-right:5px;background:url(assets/images/check_wrong.png) no-repeat center center;"></div>'}else{if(k===1){f='<div title="抵达时间：'+(d?d:"未知")+'" style="width:16px;height:16px;float:left;margin-right:5px;background:url(assets/images/check_ok.png) no-repeat center center;"></div>'}}return'<div class="check_point" style="padding:0px 10px 0px 10px;'+c+'"><div class="check_point_arrow_hide"></div><div class="'+j+'"></div>'+f+'<div class="check_point_label">'+h+"</div>"+e+"</div>"};RouteControl.prototype.scrollToCheckPoint=function(b){try{var f=$(".check_point");if(b<0){b=0}else{if(b>f.length-1){b=f.length-1}}for(var c=0,a=f.length;c<a;c++){if(c===b){f[c].childNodes[0].setAttribute("class","check_point_arrow")}else{f[c].childNodes[0].setAttribute("class","check_point_arrow_hide")}}s=f.eq(b).offset().top-f.eq(0).offset().top;if(s>0){s+=10}$("#drive_result_con").animate({scrollTop:s},200)}catch(d){console.log(d)}};RouteControl.prototype.addEventListeners=function(){var a=this;a.checkPath();$("#lushu_play_btn").on("click",function(){var c=a.data();if(this.getAttribute("class")==="play"){this.setAttribute("class","pause");this.setAttribute("title","暂停");a.mapControl().start(c.id);if(c.dispatchData&&c.dispatchData.length>0&&c.dispatchData[0].isTemp===1){a.mapControl().addTempControl(c.id)}}else{this.setAttribute("class","play");this.setAttribute("title","播放");a.mapControl().pause(c.id)}});$("#lushu_stop_btn").on("click",function(){var c=document.getElementById("lushu_play_btn");if(c){c.setAttribute("class","play");c.setAttribute("title","播放");a.mapControl().stop(a.data().id);a.mapControl().removeTempControl();a.scrollToCheckPoint(a.data().plan.lastArrivedIndex)}});$("#drive_search_box").parent().on("mousewheel",function(c){c.stopPropagation()});if(a.isAdmin()){var b=a.map();$("#drive_search_btn").on("click",function(){var e=$("#drive_start_input")[0].value;var c=$("#drive_end_input")[0].value;if(e==c){return}a.searchWayLoadingVisible(true);var d=a.driving();d.search(e,c);d.setSearchCompleteCallback(function(j){if(!j){a.searchWayLoadingVisible(false);alert("搜索路线失败。");return}var m=j.getPlan(0).getRoute(0);var t=m.getNumSteps();var o=[];for(var k=0;k<t;k++){var g=m.getStep(k);var n=g.getPosition();o.push(n)}var r=m.getPath();var q=[];q.length=0;for(var k=0,l=r.length;k<l;k++){var f=r[k];q.push([f.lng,f.lat])}a.searchPath(q);var h=function(i){a.searchData(i);a.showSearchWay(i)};a.parseLocaltion(o,h)})});$("#search_clear_btn").on("click",function(){a.clearSearchWay()});$("#search_save_btn").on("click",function(){a.saveSearchWay()})}};RouteControl.prototype.showSearchWay=function(b){var a=this;if(!a.isAdmin()){return}a.searchWayControlVisible(true);var c=ObjectUtil.cloneObj(a.data());c.plan.steps=b;c.startPos=b[0];c.endPos=b[b.length-1];$("#drive_start_input")[0].value=c.startPos.address;$("#drive_end_input")[0].value=c.endPos.address;a.checkPath(c)};RouteControl.prototype.clearSearchWay=function(b){var a=this;if(!a.isAdmin()){return}a.driving().clearResults();a.searchWayControlVisible(false);if(b){return}var c=a.data();$("#drive_start_input")[0].value=c&&c.startPos&&c.startPos.address?c.startPos.address:"";$("#drive_end_input")[0].value=c&&c.endPos&&c.endPos.address?c.endPos.address:"";a.checkPath(c)};RouteControl.prototype.saveSearchWay=function(){var b=this;if(!b.isAdmin()){return}var e=b.searchData();if(!e){return}var f=b.data();f.plan.steps=e;f.plan.path=b.searchPath();f.startPos=e[0];f.endPos=e[e.length-1];var c=b.mapControl().tracksInfo();var g=f.id;for(var d=0,a=c.length;d<a;d++){if(c[d].id===g){c[d]=f}}LocalStorageUtil.saveToDB("tracksInfo",JSON.stringify(c));b.driving().clearResults();b.searchWayControlVisible(false);b.checkPath(f);b.mapControl().removeTrack(g);b.mapControl().addTrack(f)};RouteControl.prototype.searchWayControlVisible=function(b){var a=b?"block":"none";$("#search_clear_btn").css("display",a);$("#search_save_btn").css("display",a)};RouteControl.prototype.searchWayLoadingVisible=function(c){var b=c?"block":"none";var a=$("#drive_search_box .input_con").outerHeight(true)+$("#drive_search_box .lushu_control").outerHeight(true)+$("#drive_result_con").outerHeight(true)+6;$("#drive_search_box .loading").css({display:b,height:a})};RouteControl.prototype.setContent=function(f){var b=this;var a=b.isAdmin();b.data(f);var d=b.contentDiv();if(!d){d=document.createElement("div");d.setAttribute("id","route_control");d.style.borderTop="1px solid rgba(20,255,255,0.5)";d.style.backgroundColor="none";d.style.padding="5px 5px 5px 5px";b.contentDiv(d)}var e=f&&f.startPos?f.startPos.address:"";var c=f&&f.endPos?f.endPos.address:"";var g=a?'<div id="drive_search_box"><div class="input_con"><div>起点<input id="drive_start_input" type="text"  value="'+e+'" placeholder="请输入驾车起点" autocomplete="off" maxlength="256"/></div><div>终点<input id="drive_end_input" type="text" value="'+c+'" placeholder="请输入驾车终点" autocomplete="off" maxlength="256"/></div></div><div id="drive_search_btn">搜索</div><div class="lushu_control"><div id="lushu_play_btn" class="play" title="播放"></div><div id="lushu_stop_btn" class="stop" title="停止"></div><div id="search_save_btn" class="search_save" title="保存导航结果到本地"></div><div id="search_clear_btn" class="search_clear" title="清除导航搜索结果"></div></div><div id="drive_result_con"><div id="drive_result">无规划路径</div></div><div class="loading"></div></div>':'<div id="drive_search_box"><div class="lushu_control"><div id="lushu_play_btn" class="play" title="播放"></div><div id="lushu_stop_btn" class="stop" title="停止"></div></div><div id="drive_result_con"><div id="drive_result">无规划路径</div></div></div>';d.innerHTML=g;var h=setInterval(function(){if($("#drive_search_box").length>0){clearInterval(h);if(a){b.searchWayControlVisible(false)}b.addEventListeners()}},50);return d};RouteControl.prototype.checkPath=function(m,A){var v=this;var G=m?m:v.data();if(!G||!G.plan||!G.plan.steps||G.plan.steps.length<2){$("#drive_result")[0].innerHTML="无规划路径";return}var p=new Date().getTime();var C=G.plan.steps;var u=G.posList;var E=v.map();var x=0,b=false,l=[];for(var z=0,r=C.length;z<r;z++){var n=C[z];var h=n.pos;var f=new BMap.Point(h[0],h[1]);b=false;for(var y=x,q=u.length;y<q;y++){var e=u[y].pos;var d=new BMap.Point(e[0],e[1]);var g=E.getDistance(f,d);if(g<100){x=y;b=true;l.push(1);n.time=u[y].time;n.posIndex=y;break}}if(!b){x=0;l.push(0)}}var a=0;for(var z=l.length-1;z>=0;z--){if(l[z]===1){a=z;break}l[z]=2}G.plan.lastArrivedIndex=a;if(A){return}var c="";for(var w,t,o,z=0,B=C.length,D=B-1;z<B;z++){t=C[z].address;o=C[z].time;w=l[z];if(z===0){c+=v.getPathDiv(0,w,t,o)}else{if(z===D){c+=v.getPathDiv(1,w,t,o)}else{c+=v.getPathDiv(2,w,t,o)}}}$("#drive_result")[0].innerHTML=c;v.scrollToCheckPoint(G.plan.lastArrivedIndex);$(".check_point .check_point_label").on("click",function(){var k=$(".check_point").index(this.parentNode);var j=v.mapControl().getLuShuById(G.id);var i=C[k].posIndex;j.moveTo(i)});var F=new Date().getTime();console.log("steps "+r+" , posNum "+q+" , cost time "+(F-p)+" ms.")};RouteControl.prototype.parseLocaltion=function(f,e){var b=this;if(!f||f.length===0){b.searchWayLoadingVisible(false);return}var a=[];var d=b.geoc();var c=0;var g=function(j,h){if(h>=j.length){if(e){e.call(null,a);b.searchWayLoadingVisible(false)}return}d.getLocation(j[h],function(i){var m=i.addressComponents;var l=m.city+m.district+m.street;if(m.province!==m.city){l=m.province+l}if(a.length===0||l!==a[a.length-1].address){var k=j[h];a.push({addr:l,pos:[k.lng,k.lat]})}g(j,++h)})};g(f,c)};var TempControl=function(a,c){this.defaultAnchor=BMAP_ANCHOR_BOTTOM_RIGHT;this.defaultOffset=new BMap.Size(50,50);var e=a;this.id=function(f){if(!arguments.length){return e}e=f;return this};var d=c;this.mapControl=function(f){if(!arguments.length){return d}d=f;return this};var b=null;this.contentDiv=function(f){if(!arguments.length){return b}b=f;return this}};TempControl.prototype=new BMap.Control();TempControl.prototype.initialize=function(b){var a=this;var c=a.setContent(a.id());b.getContainer().appendChild(c);return c};TempControl.prototype.setContent=function(e){var a=this;var b=a.contentDiv();if(!b){b=document.createElement("div");b.setAttribute("id","temp_control_"+e);b.style.border="1px solid rgba(20,255,255,0.15)";b.style.color="#fff";b.style.backgroundColor="rgba(68,123,175,0.75)";b.style.padding="5px 5px 5px 5px";a.contentDiv(b)}var c='<div class="tl_border"></div><div class="tr_border"></div><div class="bl_border"></div><div class="br_border"></div><div id="temp_control_con_'+e+'" style="display:none;width:350px;height:0px;"></div>';b.innerHTML=c;var d=setInterval(function(){if($("#temp_control_"+e).length>0){clearInterval(d);var f="temp_control_con_"+e;$("#"+f).css("display","block").animate({height:"200px"},200,"swing",function(){var g=a.mapControl().trackMap()[e].data.tempIns;g.lineConfig().axis.yAxis[0].tick.tickArguments=[5];g.lineConfig().axis.xAxis[0].tick.tickFormat=function(i){return d3.timeFormat("%m-%d %H:%M")(i.getTime())};var h=new ghca_charts.view.graph(f,g.lineConfig());h.render()})}},10);return b};var TableControl=function(e){var b=this;var c=true;var d=null;var a=null;this.init=function(i){var g=this;var j={"zh-cn":{ajax:{loading:"加载中",error:"加载错误"},pagination:{first:"<<",first_title:"跳转到首页",last:">>",last_title:"跳转到尾页",prev:"<",prev_title:"跳转到上一页",next:">",next_title:"跳转到下一页"}}};var h={langs:j,locale:"zh-cn",placeholder:"没有数据",height:isMutilMode?"307px":"0px",fitColumns:true,resizableColumns:false,history:false,movableColumns:false,tooltipsHeader:true,tooltips:true,selectable:1,pagination:"local",columnVertAlign:"bottom",columns:[{title:"运单编号",field:"id",width:90,formatter:function(k){return ObjectUtil.getOrinId(k.getData().id)},tooltip:function(k){return ObjectUtil.getOrinId(k.getData().id)}},{title:"当前位置",headerSort:false,formatter:function(k){var l=k.getData();return l.currentPos&&l.currentPos.address?l.currentPos.address:"未知"},tooltip:function(k){var l=k.getData();return l.currentPos&&l.currentPos.address?l.currentPos.address:"未知"}},{title:"状态",field:"status",width:70}],rowClick:function(l,m){var k=$("#table").tabulator("getSelectedData");k=k.length>0?k[0]:null;if(isMutilMode){if(k){if(k.hasOwnProperty("plan")){g.selectRow(k)}else{g.loadRowData(k)}}else{g.unselectRow(k)}}else{k?g.selectRow(k):g.unselectRow(k)}}};$("#table").tabulator(h);$("#table").tabulator("setData",i);$("#table").tabulator("setPageSize",10);$("#table").tabulator("setPage",1);var f=document.getElementById("tableHeader");f.onmousedown=function(){var k=document.getElementById("tableOpenIcon");if(c){k.textContent="∨";isMutilMode?$("#table").css({height:"0px"},200):$("#route_control").css({display:"none"},200)}else{k.textContent="∧";isMutilMode?$("#table").css({height:"307px"},200):$("#route_control").css({display:"block"},200)}e.resizeUI();c=!c}};this.loadRowData=function(f){if(f.currentPos&&f.endPos){$(".init-loading").css({display:"block","background-color":"rgba(0,0,0,0.4)"});b.searchWay(f,f.currentPos.address,f.endPos.address,function(){try{b.selectRow(f)}catch(g){}$(".init-loading").css({display:"none"})})}else{b.selectRow(f)}};this.searchWay=function(n,k,g,l){if(!k||!g){alert("您的起点或者终点地址有误!");if(l){l.call(null)}return}var i=new BMap.DrivingRoute(e.map());var f,j,h=e.geoc();if(Object.prototype.toString.call(k)==="[object String]"||Object.prototype.toString.call(k)==="[object String]"){h.getPoint(k,function(o){if(o){f=o;h.getPoint(g,function(p){if(p){j=p;m(l)}else{alert("您的终点地址没有解析到结果!");if(l){l.call(null)}}})}else{alert("您的起点地址没有解析到结果!");if(l){l.call(null)}}})}else{f=new BMap.Point(k[0],k[1]);j=new BMap.Point(g[0],g[1]);m(l)}function m(p){i.search(f,j);var o=0;i.setSearchCompleteCallback(function(t){i.setSearchCompleteCallback(null);var x=t.getPlan(0).getRoute(0);var B=x.getNumSteps();var z=[];for(var u=0;u<B;u++){var r=x.getStep(u);var y=r.getPosition();z.push(y)}var w={path:[],steps:[]};n.plan=w;var A=x.getPath();for(var u=0,v=A.length;u<v;u++){var q=A[u];w.path.push([q.lng,q.lat])}if(p){p.call(null)}})}};this.stopLuShu=function(h){var f=document.getElementById("lushu_play_btn");f.setAttribute("class","play");f.setAttribute("title","播放");var g=e.getLuShuById(h);if(g){g.stop()}e.removeTempControl()};this.selectRow=function(h){if(!h){return}var f,g=e.treeControl;if(!d){d=h;g.setContent(d);e.addTrack(d)}else{if(d&&d.id!==h.id){b.stopLuShu(d.id);e.removeTrack(d.id);d=h;g.setContent(d);e.addTrack(d)}}e.selectTrack(d.id,true);var i=setTimeout(function(){clearTimeout(i);e.selectCar(d.id,true)},300)};this.unselectRow=function(j){var g,i=e.treeControl,f=j?j:d;i.setContent(null);e.removeTrack(f.id);b.stopLuShu(f.id);e.addCar(f);d=null;var h=e.infoControl;if(h){h.hide()}var i=e.treeControl;if(i){i.hide()}}};var TreeControl=function(d){var a=this;this.defaultAnchor=BMAP_ANCHOR_TOP_LEFT;this.defaultOffset=new BMap.Size(15,370);var g=d;this.mapControl=function(h){if(!arguments.length){return g}g=h;return this};var c=null;this.contentDiv=function(h){if(!arguments.length){return c}c=h;return this};var e=null;this.data=function(h){if(!arguments.length){return e}e=h;return this};var f=null;this.treeData=function(h){if(!arguments.length){return f}f=h;return this};var b={view:{showIcon:function(i,h){return !h.isParent},showLine:false,showTitle:true},data:{key:{name:function(h){return h.level===0?"id":"address"},title:function(h){return h.level===0?"装车单号：{#node.id#}":"抵达地点：{#node.address#}\n抵达时间：{#node.time#}"},children:"posList"},simpleData:{enable:false}},callback:{onClick:function(l,n,k,i){if(k.level===1&&i){var m=a.data();var n=m.id;var j=a.mapControl().getLuShuById(n);if(j){a.mapControl().visibleCar(n,false);if(m.dispatchData&&m.dispatchData.length>0&&m.dispatchData[0].isTemp===1){a.mapControl().addTempControl(n)}j.moveTo(k.index);var h=document.getElementById("lushu_play_btn");if(h.getAttribute("class")!=="play"){h.setAttribute("class","play");h.setAttribute("title","播放")}}}else{if(k.level===0&&i){}}}}};this.setting=function(h){if(!arguments.length){return b}b=h;return this}};TreeControl.prototype=new BMap.Control();TreeControl.prototype.initialize=function(b){var a=this;var c=a.setContent();$(c).on("mousewheel",function(d){d.stopPropagation()});b.getContainer().appendChild(c);return c};TreeControl.prototype.getTreeData=function(c){if(!c){return null}var k=ObjectUtil.cloneObj(c.dispatchData);var e=0;for(var h,d=0,f=k.length;d<f;d++){h=k[d];h.open=true;var g=h.posList;if(!g){continue}for(var b=0,a=g.length;b<a;b++){g[b].index=e;e++}}return k};TreeControl.prototype.setContent=function(f){var a=this;a.data(f);var c=a.getTreeData(f);a.treeData(c);var b=a.contentDiv();if(!b){b=document.createElement("div");b.setAttribute("id","tree_control");b.style.border="1px solid rgba(20,255,255,0.15)";b.style.color="#fff";b.style.backgroundColor="rgba(68,123,175,0.75)";b.style.padding="5px 5px 5px 5px";b.style.width="290px";a.contentDiv(b)}var e='<div class="tl_border"></div><div class="tr_border"></div><div class="bl_border"></div><div class="br_border"></div><div class="lushu_control"><div id="lushu_play_btn" class="play" title="播放"></div><div id="lushu_stop_btn" class="stop" title="停止"></div></div><div id="sectionsTree" class="ztree"></div>';b.innerHTML=e;if(a.data()){$.fn.zTree.init($("#sectionsTree"),a.setting(),a.treeData())}else{$.fn.zTree.destroy()}a.addEventListeners();a.mapControl().resizeUI();b.style.display=a.treeData()?"block":"none";if(f&&f.posList&&f.posList.length>0){var g=setTimeout(function(){clearTimeout(g);a.scrollToCheckPoint(f.posList.length-1)},300)}return b};TreeControl.prototype.addEventListeners=function(){var a=this,b=a.data();$("#lushu_play_btn").on("click",function(){if(this.getAttribute("class")==="play"){this.setAttribute("class","pause");this.setAttribute("title","暂停");a.mapControl().start(b.id);if(b.dispatchData&&b.dispatchData.length>0&&b.dispatchData[0].isTemp===1){a.mapControl().addTempControl(b.id)}}else{this.setAttribute("class","play");this.setAttribute("title","播放");a.mapControl().pause(b.id)}});$("#lushu_stop_btn").on("click",function(){var c=document.getElementById("lushu_play_btn");if(c){c.setAttribute("class","play");c.setAttribute("title","播放");a.mapControl().stop(b.id);a.mapControl().removeTempControl();if(b&&b.posList&&b.posList.length>0){a.scrollToCheckPoint(b.posList.length-1)}}})};TreeControl.prototype.scrollToCheckPoint=function(b){try{var f=$("#sectionsTree .play_icon");if(b<0){b=0}else{if(b>f.length-1){b=f.length-1}}for(var c=0,a=f.length;c<a;c++){if(c===b){f[c].setAttribute("class","play_icon check_point_arrow")}else{f[c].setAttribute("class","play_icon check_point_arrow_hide")}}s=f.eq(b).offset().top-f.eq(0).offset().top;if(s>0){s+=10}$("#sectionsTree").animate({scrollTop:s},200)}catch(d){console.log(d)}};var LocalStorageUtil={saveToDB:function(a,b){try{localStorage.setItem(a,b);alert("保存数据成功")}catch(c){alert("保存数据失败")}},readFromDB:function readFromDB(a){try{var b=localStorage.getItem(a)}catch(c){alert("读取数据失败")}return b},clearDB:function(){try{localStorage.clear();alert("清除数据成功")}catch(a){alert("清除数据失败")}}};var ColorUtil={PATH_COLOR:["#ff5722","#ae81db","#fbe38f","#ffffff","#e7b8bb"],getColor:function(a){if(a<0){a=0}return ColorUtil.PATH_COLOR[a%ColorUtil.PATH_COLOR.length]}};var ObjectUtil={cloneObj:function(c){var d,b=c.constructor===Array?[]:{};if(typeof c!=="object"){return}else{if(window.JSON){d=JSON.stringify(c),b=JSON.parse(d)}else{for(var a in c){b[a]=typeof c[a]==="object"?cloneObj(c[a]):c[a]}}}return b},getQueryString:function(a){var b=new RegExp("(^|&)"+a+"=([^&]*)(&|$)");var c=window.location.search.substr(1).match(b);if(c!=null){return unescape(c[2])}return null},filterObj:function(d,b,a){if(a===undefined){a=""}if(!d){return a}var c=d[b];return c===undefined||c===null?a:c},getOrinId:function(a){return Object.prototype.toString.call(a)==="[object String]"?a.replace("_","@"):"未知"}};Date.prototype.Format=function(a){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(a)){a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var b in c){if(new RegExp("("+b+")").test(a)){a=a.replace(RegExp.$1,(RegExp.$1.length==1)?(c[b]):(("00"+c[b]).substr((""+c[b]).length)))}}return a};